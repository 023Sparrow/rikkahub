package me.rerere.rikkahub

import kotlinx.coroutines.flow.first
import kotlinx.coroutines.runBlocking
import me.rerere.rikkahub.data.db.entity.MemoryTable
import me.rerere.rikkahub.data.db.entity.MemoryTableRow
import me.rerere.rikkahub.data.repository.MemoryTableRepository
import org.junit.Test
import org.junit.Assert.*
import org.junit.Before

/**
 * MemoryTableRepository单元测试
 * 测试记忆表格的CRUD操作和查询功能
 * 
 * 注意：这是一个单元测试示例，实际测试需要配置Room的内存数据库
 * 或使用MockK等框架模拟DAO
 */
class MemoryTableRepositoryTest {

    // 注意：实际测试需要初始化Room内存数据库和DAO
    // private lateinit var database: AppDatabase
    // private lateinit var dao: MemoryTableDAO
    // private lateinit var repository: MemoryTableRepository

    @Test
    fun `test basic repository structure`() {
        // 这是一个结构性测试，验证数据模型的正确性
        
        // 创建测试数据
        val table = MemoryTable(
            id = 1L,
            name = "Character Info",
            description = "Basic character information",
            columns = listOf("Name", "Age", "Occupation")
        )

        val row = MemoryTableRow(
            id = 1L,
            tableId = 1L,
            values = mapOf(
                "Name" to "Alice",
                "Age" to "25",
                "Occupation" to "Engineer"
            )
        )

        // 验证数据模型
        assertEquals("Character Info", table.name)
        assertEquals(3, table.columns.size)
        assertTrue(table.columns.contains("Name"))
        
        assertEquals(1L, row.tableId)
        assertEquals("Alice", row.values["Name"])
        assertEquals(3, row.values.size)
    }

    @Test
    fun `test table column validation`() {
        val columns = listOf("Col1", "Col2", "Col3")
        
        // 验证列定义
        assertTrue(columns.isNotEmpty())
        assertEquals(3, columns.size)
        assertTrue(columns.all { it.isNotBlank() })
    }

    @Test
    fun `test row values match columns`() {
        val table = MemoryTable(
            id = 1L,
            name = "Test Table",
            description = "Test",
            columns = listOf("A", "B", "C")
        )

        val validRow = MemoryTableRow(
            id = 1L,
            tableId = 1L,
            values = mapOf(
                "A" to "value1",
                "B" to "value2",
                "C" to "value3"
            )
        )

        // 验证行数据的列与表定义匹配
        table.columns.forEach { column ->
            assertTrue(validRow.values.containsKey(column))
        }
    }

    @Test
    fun `test empty table columns`() {
        val table = MemoryTable(
            id = 1L,
            name = "Empty Table",
            description = "No columns",
            columns = emptyList()
        )

        // 空列表应该有效
        assertTrue(table.columns.isEmpty())
    }

    @Test
    fun `test row with missing values`() {
        val table = MemoryTable(
            id = 1L,
            name = "Test Table",
            description = "Test",
            columns = listOf("A", "B", "C")
        )

        val partialRow = MemoryTableRow(
            id = 1L,
            tableId = 1L,
            values = mapOf(
                "A" to "value1",
                "B" to "" // 空值
                // 缺少 "C"
            )
        )

        // 验证部分填充的行
        assertTrue(partialRow.values.containsKey("A"))
        assertTrue(partialRow.values.containsKey("B"))
        assertFalse(partialRow.values.containsKey("C"))
    }

    @Test
    fun `test multiple rows in same table`() {
        val tableId = 1L
        
        val rows = listOf(
            MemoryTableRow(
                id = 1L,
                tableId = tableId,
                values = mapOf("Name" to "Alice", "Age" to "25")
            ),
            MemoryTableRow(
                id = 2L,
                tableId = tableId,
                values = mapOf("Name" to "Bob", "Age" to "30")
            ),
            MemoryTableRow(
                id = 3L,
                tableId = tableId,
                values = mapOf("Name" to "Carol", "Age" to "28")
            )
        )

        // 验证多行数据
        assertEquals(3, rows.size)
        assertTrue(rows.all { it.tableId == tableId })
        assertEquals(listOf(1L, 2L, 3L), rows.map { it.id })
    }

    @Test
    fun `test table update operations`() {
        val original = MemoryTable(
            id = 1L,
            name = "Original Name",
            description = "Original Description",
            columns = listOf("A", "B")
        )

        val updated = original.copy(
            name = "Updated Name",
            description = "Updated Description",
            columns = listOf("A", "B", "C")
        )

        // 验证更新操作
        assertEquals(original.id, updated.id)
        assertNotEquals(original.name, updated.name)
        assertNotEquals(original.description, updated.description)
        assertNotEquals(original.columns.size, updated.columns.size)
        assertEquals("Updated Name", updated.name)
        assertEquals(3, updated.columns.size)
    }

    @Test
    fun `test row update operations`() {
        val original = MemoryTableRow(
            id = 1L,
            tableId = 1L,
            values = mapOf("Name" to "Alice", "Age" to "25")
        )

        val updated = original.copy(
            values = mapOf("Name" to "Alice Smith", "Age" to "26", "City" to "NYC")
        )

        // 验证行更新
        assertEquals(original.id, updated.id)
        assertEquals(original.tableId, updated.tableId)
        assertNotEquals(original.values, updated.values)
        assertEquals("Alice Smith", updated.values["Name"])
        assertEquals(3, updated.values.size)
    }

    @Test
    fun `test column name constraints`() {
        // 验证列名约束
        val validColumns = listOf("Name", "Age", "City")
        val invalidColumns = listOf("", "   ", "\n")

        // 有效列名
        assertTrue(validColumns.all { it.isNotBlank() })
        assertTrue(validColumns.none { it.trim() != it })

        // 无效列名（应该在UI层或Repository层被拒绝）
        assertTrue(invalidColumns.any { it.isBlank() })
    }

    @Test
    fun `test search by column value`() {
        val rows = listOf(
            MemoryTableRow(1L, 1L, mapOf("Name" to "Alice", "City" to "NYC")),
            MemoryTableRow(2L, 1L, mapOf("Name" to "Bob", "City" to "LA")),
            MemoryTableRow(3L, 1L, mapOf("Name" to "Charlie", "City" to "NYC"))
        )

        // 模拟搜索功能
        val searchColumn = "City"
        val searchValue = "NYC"
        val matches = rows.filter { 
            it.values[searchColumn]?.contains(searchValue, ignoreCase = true) == true
        }

        assertEquals(2, matches.size)
        assertTrue(matches.all { it.values[searchColumn] == "NYC" })
    }

    @Test
    fun `test table deletion cascade behavior`() {
        // 验证级联删除的数据结构
        val tableId = 1L
        val table = MemoryTable(
            id = tableId,
            name = "Test Table",
            description = "Test",
            columns = listOf("A", "B")
        )

        val rows = listOf(
            MemoryTableRow(1L, tableId, mapOf("A" to "1")),
            MemoryTableRow(2L, tableId, mapOf("A" to "2"))
        )

        // 验证关联
        assertTrue(rows.all { it.tableId == table.id })
        
        // 在实际实现中，删除table时应该级联删除所有关联的rows
        // 这通过Room的@ForeignKey(onDelete = CASCADE)实现
    }

    @Test
    fun `test column reordering`() {
        val original = MemoryTable(
            id = 1L,
            name = "Test",
            description = "Test",
            columns = listOf("A", "B", "C")
        )

        val reordered = original.copy(
            columns = listOf("C", "A", "B")
        )

        // 验证重新排序
        assertEquals(original.columns.size, reordered.columns.size)
        assertEquals(original.columns.toSet(), reordered.columns.toSet())
        assertNotEquals(original.columns, reordered.columns)
        assertEquals("C", reordered.columns[0])
    }

    @Test
    fun `test adding new column to existing table`() {
        val original = MemoryTable(
            id = 1L,
            name = "Test",
            description = "Test",
            columns = listOf("A", "B")
        )

        val withNewColumn = original.copy(
            columns = original.columns + "C"
        )

        assertEquals(2, original.columns.size)
        assertEquals(3, withNewColumn.columns.size)
        assertTrue(withNewColumn.columns.contains("C"))
        assertTrue(withNewColumn.columns.containsAll(original.columns))
    }

    @Test
    fun `test removing column from table`() {
        val original = MemoryTable(
            id = 1L,
            name = "Test",
            description = "Test",
            columns = listOf("A", "B", "C")
        )

        val withRemovedColumn = original.copy(
            columns = original.columns.filter { it != "B" }
        )

        assertEquals(3, original.columns.size)
        assertEquals(2, withRemovedColumn.columns.size)
        assertFalse(withRemovedColumn.columns.contains("B"))
        assertTrue(withRemovedColumn.columns.containsAll(listOf("A", "C")))
    }
}