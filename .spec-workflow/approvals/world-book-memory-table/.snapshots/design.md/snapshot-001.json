{
  "id": "snapshot_1762483345822_23fa5m2wk",
  "approvalId": "approval_1762483345794_h6hpdu6ru",
  "approvalTitle": "World Book和Memory Table技术设计文档",
  "version": 1,
  "timestamp": "2025-11-07T02:42:25.822Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Design Document\r\n\r\n## Overview\r\n\r\nWorld Book和Memory Table功能将为RikkaHub Android LLM聊天客户端添加知识库管理和动态数据表格功能。该设计充分利用现有的Room数据库、Koin依赖注入和Jetpack Compose架构，将现有的Fragment实现完全迁移到现代Compose UI架构，同时优化算法性能和用户体验。\r\n\r\n## Steering Document Alignment\r\n\r\n### Technical Standards (tech.md)\r\n设计遵循RikkaHub现有的技术栈和最佳实践：\r\n- **Jetpack Compose**: 使用现代化声明式UI框架替换Fragment\r\n- **MVVM架构**: 通过ViewModel管理UI状态和业务逻辑\r\n- **Repository模式**: 数据访问层抽象，便于测试和维护\r\n- **Koin依赖注入**: 保持与主应用一致的依赖管理\r\n- **Room数据库**: 利用现有数据库架构，添加必要的索引优化\r\n\r\n### Project Structure (structure.md)\r\n实现将遵循现有的模块化组织：\r\n- **app/ui/pages/worldbook/**: World Book功能的Compose页面和ViewModel\r\n- **app/ui/pages/memorytable/**: Memory Table功能的Compose页面和ViewModel\r\n- **app/data/repository/**: 数据访问层实现\r\n- **app/service/**: 业务逻辑服务层\r\n- **app/data/db/entity/**: 数据库实体定义（已存在）\r\n\r\n## Code Reuse Analysis\r\n\r\n### Existing Components to Leverage\r\n- **SettingProviderPage.kt**: 作为页面布局和导航的参考模板\r\n- **FormItem组件**: 用于表单布局的一致性UI组件\r\n- **Lucide图标库**: 统一的图标系统\r\n- **LocalToaster**: 统一的消息提示系统\r\n- **PreferencesStore**: 设置存储机制\r\n\r\n### Integration Points\r\n- **现有导航系统**: 将新页面集成到Navigation Compose路由中\r\n- **AI聊天系统**: 通过WorldBookInjector和MemoryTableInjector集成到对话流程\r\n- **数据库架构**: 扩展现有的AppDatabase，添加新索引\r\n- **主题系统**: 遵循Material Design 3和现有主题规范\r\n\r\n## Architecture\r\n\r\n### Modular Design Principles\r\n- **Single File Responsibility**: 每个Compose页面负责单一功能界面\r\n- **Component Isolation**: 创建可复用的UI组件（如条目编辑器、表格单元格）\r\n- **Service Layer Separation**: 分离数据访问、业务逻辑和UI展示\r\n- **Utility Modularity**: 将匹配算法、格式化工具等独立为工具模块\r\n\r\n```mermaid\r\ngraph TD\r\n    A[WorldBookPage] --> B[WorldBookViewModel]\r\n    A --> C[WorldBookRepository]\r\n    B --> D[WorldBookMatcher]\r\n    B --> E[WorldBookInjector]\r\n    C --> F[WorldBookDao]\r\n    F --> G[Room Database]\r\n\r\n    H[MemoryTablePage] --> I[MemoryTableViewModel]\r\n    H --> J[MemoryTableRepository]\r\n    I --> K[TableDataFormatter]\r\n    I --> L[MemoryTableInjector]\r\n    J --> M[MemoryTableDao]\r\n    M --> G\r\n\r\n    D --> N[AI Chat Context]\r\n    L --> N\r\n```\r\n\r\n## Components and Interfaces\r\n\r\n### WorldBookPage (Compose)\r\n- **Purpose:** World Book功能的主界面，提供条目管理UI\r\n- **Interfaces:**\r\n  - `onCreateEntry()`: 创建新条目\r\n  - `onEditEntry(entry)`: 编辑现有条目\r\n  - `onDeleteEntry(entry)`: 删除条目\r\n  - `onSearch(query)`: 搜索条目\r\n- **Dependencies:** WorldBookViewModel, Navigation Controller\r\n- **Reuses:** SettingProviderPage布局模式, FormItem组件\r\n\r\n### WorldBookViewModel\r\n- **Purpose:** 管理World Book UI状态和业务逻辑\r\n- **Interfaces:**\r\n  - `loadEntries()`: 加载条目列表\r\n  - `saveEntry(entry)`: 保存条目\r\n  - `deleteEntry(entryId)`: 删除条目\r\n  - `searchEntries(query)`: 搜索条目\r\n- **Dependencies:** WorldBookRepository, CoroutineScope\r\n- **Reuses:** 现有ViewModel模式和状态管理\r\n\r\n### WorldBookMatcher (优化)\r\n- **Purpose:** 高性能关键词匹配算法\r\n- **Interfaces:**\r\n  - `matchWorldBookEntries(input)`: 匹配相关条目\r\n  - `calculateRelevance(entry, keywords)`: 计算相关性分数\r\n- **Dependencies:** 算法优化工具, 缓存机制\r\n- **Reuses:** 现有匹配逻辑，优化时间复杂度\r\n\r\n### MemoryTablePage (Compose)\r\n- **Purpose:** Memory Table功能的主界面，提供表格编辑UI\r\n- **Interfaces:**\r\n  - `onCreateTable()`: 创建新表格\r\n  - `onEditCell(tableId, row, col, value)`: 编辑单元格\r\n  - `onAddRow(tableId)`: 添加行\r\n  - `onAddColumn(tableId, columnName)`: 添加列\r\n- **Dependencies:** MemoryTableViewModel, Table Editor组件\r\n- **Reuses:** 表格UI组件, 拖拽排序功能\r\n\r\n### TableEditorComponent (可复用)\r\n- **Purpose:** 动态表格编辑器组件\r\n- **Interfaces:**\r\n  - `onCellChange(row, col, value)`: 单元格值变更\r\n  - `onRowAdd()`: 添加行\r\n  - `onColumnAdd(name)`: 添加列\r\n- **Dependencies:** Compose状态管理, 拖拽手势处理\r\n- **Reuses:** 现有Compose交互模式\r\n\r\n## Data Models\r\n\r\n### WorldBookEntry (现有，需优化)\r\n```kotlin\r\n@Entity(tableName = \"world_book_entries\", indices = [\r\n    Index(value = [\"keywords\"]),\r\n    Index(value = [\"priority\"]),\r\n    Index(value = [\"enabled\"])\r\n])\r\ndata class WorldBookEntry(\r\n    @PrimaryKey val id: String = UUID.randomUUID().toString(),\r\n    val name: String,\r\n    val content: String,\r\n    val keywords: List<String>, // 存储为JSON字符串\r\n    val priority: Int = 0,\r\n    val enabled: Boolean = true,\r\n    val createdAt: Long = System.currentTimeMillis(),\r\n    val updatedAt: Long = System.currentTimeMillis()\r\n)\r\n```\r\n\r\n### MemoryTable (现有，需完善)\r\n```kotlin\r\n@Entity(tableName = \"memory_tables\", indices = [\r\n    Index(value = [\"name\"]),\r\n    Index(value = [\"createdAt\"])\r\n])\r\ndata class MemoryTable(\r\n    @PrimaryKey val id: String = UUID.randomUUID().toString(),\r\n    val name: String,\r\n    val columns: List<MemoryColumn>, // 存储为JSON\r\n    val rows: List<MemoryRow>, // 存储为JSON\r\n    val createdAt: Long = System.currentTimeMillis(),\r\n    val updatedAt: Long = System.currentTimeMillis()\r\n)\r\n\r\ndata class MemoryColumn(\r\n    val name: String,\r\n    val type: ColumnType = ColumnType.TEXT\r\n)\r\n\r\ndata class MemoryRow(\r\n    val id: String = UUID.randomUUID().toString(),\r\n    val cells: List<String> // 与columns对应的值列表\r\n)\r\n\r\nenum class ColumnType {\r\n    TEXT, NUMBER, DATE, BOOLEAN\r\n}\r\n```\r\n\r\n## Error Handling\r\n\r\n### Error Scenarios\r\n1. **数据库操作失败**\r\n   - **Handling:** 使用try-catch包装Repository操作，通过ViewModel传递错误状态到UI\r\n   - **User Impact:** 显示友好的错误消息和重试按钮\r\n\r\n2. **关键词匹配算法性能问题**\r\n   - **Handling:** 实现超时机制和降级策略，缓存匹配结果\r\n   - **User Impact:** 长时间操作时显示进度指示器\r\n\r\n3. **内存表格数据损坏**\r\n   - **Handling:** JSON解析异常处理，数据验证和自动修复\r\n   - **User Impact:** 提供数据恢复选项和错误详情\r\n\r\n4. **AI上下文注入失败**\r\n   - **Handling:** 优雅降级，记录错误日志，不影响正常对话\r\n   - **User Impact:** 静默处理，可选显示警告信息\r\n\r\n## Testing Strategy\r\n\r\n### Unit Testing\r\n- **Repository层测试:** 模拟Dao接口，测试CRUD操作\r\n- **ViewModel测试:** 测试状态管理和业务逻辑\r\n- **匹配算法测试:** 验证关键词匹配的准确性和性能\r\n- **工具函数测试:** JSON序列化、数据格式化等\r\n\r\n### Integration Testing\r\n- **数据库集成测试:** 测试Room数据库操作和事务\r\n- **AI集成测试:** 测试上下文注入功能\r\n- **导航集成测试:** 测试页面间导航和数据传递\r\n\r\n### End-to-End Testing\r\n- **用户流程测试:** 创建、编辑、删除World Book条目\r\n- **表格操作测试:** 创建表格、编辑数据、添加行列\r\n- **AI对话测试:** 验证World Book和Memory Table在对话中的效果\r\n- **性能测试:** 大量数据下的响应时间和内存使用",
  "fileStats": {
    "size": 7656,
    "lines": 204,
    "lastModified": "2025-11-07T02:42:16.210Z"
  },
  "comments": []
}