{
  "id": "snapshot_1762483587475_emz4957b3",
  "approvalId": "approval_1762483470776_ouwigi6dd",
  "approvalTitle": "World Book和Memory Table功能实施任务分解",
  "version": 2,
  "timestamp": "2025-11-07T02:46:27.475Z",
  "trigger": "revision_requested",
  "status": "pending",
  "content": "# Tasks Document\r\n\r\n## Phase 1: 数据层优化和基础架构\r\n\r\n- [ ] 1.1 优化WorldBookEntry数据库索引\r\n  - File: app/src/main/java/me/rerere/rikkahub/data/db/entity/WorldBookEntry.kt\r\n  - 添加复合索引优化关键词匹配查询性能\r\n  - 修复数据库结构和索引配置\r\n  - Purpose: 解决World Book查询性能问题，支持100ms内响应\r\n  - _Leverage: app/src/main/java/me/rerere/rikkahub/data/db/AppDatabase.kt_\r\n  - _Requirements: 4.1_\r\n  - _Prompt: Role: Android Database Engineer specializing in Room and SQLite optimization | Task: Implement database index optimization for WorldBookEntry entity to resolve performance issues, ensuring queries complete within 100ms for 1000 entries, leveraging existing AppDatabase patterns | Restrictions: Must maintain data migration compatibility, follow Room indexing best practices, do not break existing queries | Success: Database queries execute within performance targets, proper indexes are created and used by query planner, migration scripts work correctly_\r\n\r\n- [ ] 1.2 修复MemoryTable数据模型\r\n  - File: app/src/main/java/me/rerere/rikkahub/data/db/entity/MemoryTable.kt\r\n  - 完善MemoryTable实体类和相关数据类\r\n  - 添加JSON序列化支持和类型转换器\r\n  - Purpose: 修复MemoryTable编译错误，完善数据结构\r\n  - _Leverage: app/src/main/java/me/rerere/rikkahub/data/db/converters/Converters.kt_\r\n  - _Requirements: 2.1, 2.2_\r\n  - _Prompt: Role: Android Data Model Engineer with expertise in Room entities and JSON serialization | Task: Fix MemoryTable entity compilation errors and implement proper data structure with JSON serialization support, using existing converter patterns | Restrictions: Must follow Room entity conventions, ensure proper type conversion, maintain data integrity | Success: MemoryTable compiles without errors, JSON serialization works correctly, all data types are properly handled_\r\n\r\n- [ ] 1.3 创建WorldBookRepository\r\n  - File: app/src/main/java/me/rerere/rikkahub/data/repository/WorldBookRepository.kt\r\n  - 实现World Book数据访问层\r\n  - 添加CRUD操作和查询优化\r\n  - Purpose: 提供World Book的数据访问抽象层\r\n  - _Leverage: app/src/main/java/me/rerere/rikkahub/data/db/dao/WorldBookDao.kt_\r\n  - _Requirements: 1.1, 1.2, 1.3_\r\n  - _Prompt: Role: Android Repository Pattern Specialist | Task: Create WorldBookRepository implementing all CRUD operations with optimized queries, following existing repository patterns in the project and leveraging WorldBookDao | Restrictions: Must use proper coroutine patterns, handle database errors gracefully, follow single responsibility principle | Success: Repository provides clean API for data operations, all CRUD methods work correctly, queries are optimized and efficient_\r\n\r\n- [ ] 1.4 创建MemoryTableRepository\r\n  - File: app/src/main/java/me/rerere/rikkahub/data/repository/MemoryTableRepository.kt\r\n  - 实现Memory Table数据访问层\r\n  - 添加表格数据的JSON处理和查询功能\r\n  - Purpose: 提供Memory Table的数据访问抽象层\r\n  - _Leverage: app/src/main/java/me/rerere/rikkahub/data/db/dao/MemoryTableDao.kt_\r\n  - _Requirements: 2.1, 2.2, 2.3_\r\n  - _Prompt: Role: Android Repository Pattern Specialist | Task: Create MemoryTableRepository with JSON data handling capabilities, implementing all table operations and leveraging existing MemoryTableDao patterns | Restrictions: Must handle JSON serialization safely, provide transaction support for complex operations, maintain data consistency | Success: Repository handles table operations correctly, JSON data is properly serialized/deserialized, transactions maintain data integrity_\r\n\r\n## Phase 2: 业务逻辑层优化\r\n\r\n- [ ] 2.1 优化WorldBookMatcher算法\r\n  - File: app/src/main/java/me/rerere/rikkahub/service/WorldBookMatcher.kt\r\n  - 重构关键词匹配算法，优化时间复杂度\r\n  - 添加缓存机制和结果排序\r\n  - Purpose: 将匹配算法从O(n*m*k)优化到O(n*m)\r\n  - _Leverage: app/src/main/java/me/rerere/rikkahub/utils/StringUtils.kt_\r\n  - _Requirements: 4.1_\r\n  - _Prompt: Role: Algorithm Engineer with expertise in string matching and performance optimization | Task: Optimize WorldBookMatcher algorithm from O(n*m*k) to O(n*m) complexity, implement caching mechanism and result ranking, leveraging existing string utilities | Restrictions: Must maintain matching accuracy, improve performance significantly, handle edge cases properly | Success: Algorithm executes within 100ms for 1000 entries, maintains matching accuracy, provides consistent result ordering_\r\n\r\n- [ ] 2.2 改进WorldBookInjector服务\r\n  - File: app/src/main/java/me/rerere/rikkahub/service/WorldBookInjector.kt\r\n  - 优化上下文注入逻辑和格式化\r\n  - 添加多种注入格式支持\r\n  - Purpose: 改进AI上下文注入的质量和灵活性\r\n  - _Leverage: app/src/main/java/me/rerere/rikkahub/ai/model/ChatMessage.kt_\r\n  - _Requirements: 1.5, 4.1_\r\n  - _Prompt: Role: AI Integration Specialist | Task: Enhance WorldBookInjector with improved context formatting and multiple injection styles, ensuring seamless integration with existing chat message system | Restrictions: Must maintain compatibility with AI providers, provide configurable injection formats, handle edge cases gracefully | Success: Injector provides high-quality context injection, supports multiple formatting options, integrates smoothly with chat system_\r\n\r\n- [ ] 2.3 创建MemoryTableInjector服务\r\n  - File: app/src/main/java/me/rerere/rikkahub/service/MemoryTableInjector.kt\r\n  - 实现Memory Table数据的AI上下文注入\r\n  - 添加表格数据格式化和查询功能\r\n  - Purpose: 为AI对话提供结构化的表格数据支持\r\n  - _Leverage: app/src/main/java/me/rerere/rikkahub/service/WorldBookInjector.kt_\r\n  - _Requirements: 2.5_\r\n  - _Prompt: Role: AI Integration Specialist | Task: Create MemoryTableInjector service to format and inject structured table data into AI context, following patterns established by WorldBookInjector | Restrictions: Must handle various table formats, provide flexible data representation, maintain context relevance | Success: Injector effectively formats table data for AI consumption, supports various data types, provides relevant context injection_\r\n\r\n## Phase 3: UI层迁移到Compose\r\n\r\n- [ ] 3.1 创建WorldBookViewModel\r\n  - File: app/src/main/java/me/rerere/rikkahub/ui/pages/worldbook/WorldBookViewModel.kt\r\n  - 实现MVVM架构的ViewModel\r\n  - 添加状态管理和业务逻辑处理\r\n  - Purpose: 为World Book Compose UI提供状态管理\r\n  - _Leverage: app/src/main/java/me/rerere/rikkahub/ui/pages/setting/SettingProviderViewModel.kt_\r\n  - _Requirements: 1.1, 1.2, 1.3, 3.1_\r\n  - _Prompt: Role: Android MVVM Architect with Jetpack Compose expertise | Task: Create WorldBookViewModel following established ViewModel patterns, implementing state management with StateFlow and handling all World Book operations | Restrictions: Must follow coroutine best practices, handle lifecycle properly, separate UI state from business logic | Success: ViewModel provides reactive state management, handles all operations correctly, integrates smoothly with Compose UI_\r\n\r\n- [ ] 3.2 创建WorldBookPage Compose界面\r\n  - File: app/src/main/java/me/rerere/rikkahub/ui/pages/worldbook/WorldBookPage.kt\r\n  - 实现Jetpack Compose UI界面\r\n  - 添加条目列表、编辑和搜索功能\r\n  - Purpose: 替换Fragment实现，提供现代化UI\r\n  - _Leverage: app/src/main/java/me/rerere/rikkahub/ui/pages/setting/SettingProviderPage.kt_\r\n  - _Requirements: 1.1, 1.2, 1.3, 3.1, 3.2, 3.3_\r\n  - _Prompt: Role: Android Compose UI Specialist | Task: Create WorldBookPage using Jetpack Compose with material design, implementing entry list, editing, and search features, following SettingProviderPage patterns | Restrictions: Must follow Material Design 3 guidelines, use existing UI components, ensure accessibility and responsive design | Success: Compose UI provides smooth user experience, all features work correctly, integrates with navigation system_\r\n\r\n- [ ] 3.3 创建MemoryTableViewModel\r\n  - File: app/src/main/java/me/rerere/rikkahub/ui/pages/memorytable/MemoryTableViewModel.kt\r\n  - 实现Memory Table的ViewModel\r\n  - 添加表格状态管理和编辑逻辑\r\n  - Purpose: 为Memory Table Compose UI提供状态管理\r\n  - _Leverage: app/src/main/java/me/rerere/rikkahub/ui/pages/worldbook/WorldBookViewModel.kt_\r\n  - _Requirements: 2.1, 2.2, 2.3, 2.4, 3.1_\r\n  - _Prompt: Role: Android MVVM Architect with Jetpack Compose expertise | Task: Create MemoryTableViewModel with complex table state management, handling dynamic tables with editable cells, following WorldBookViewModel patterns | Restrictions: Must handle dynamic table structures efficiently, provide real-time updates, maintain data consistency | Success: ViewModel handles complex table operations smoothly, provides reactive updates for all table changes_\r\n\r\n- [ ] 3.4 创建MemoryTablePage Compose界面\r\n  - File: app/src/main/java/me/rerere/rikkahub/ui/pages/memorytable/MemoryTablePage.kt\r\n  - 实现动态表格编辑的Compose UI\r\n  - 添加行列操作和单元格编辑功能\r\n  - Purpose: 替换Fragment实现，提供现代化表格编辑体验\r\n  - _Leverage: app/src/main/java/me/rerere/rikkahub/ui/pages/worldbook/WorldBookPage.kt_\r\n  - _Requirements: 2.1, 2.2, 2.3, 2.4, 3.1, 3.2, 3.3_\r\n  - _Prompt: Role: Android Compose UI Specialist with table component expertise | Task: Create MemoryTablePage with dynamic table editing capabilities, implementing row/column operations and cell editing, following established Compose patterns | Restrictions: Must handle variable table structures smoothly, provide intuitive editing experience, maintain performance with large tables | Success: Table UI is responsive and intuitive, all editing operations work correctly, handles large datasets efficiently_\r\n\r\n## Phase 4: 导航集成和系统整合\r\n\r\n- [ ] 4.1 更新应用导航路由\r\n  - File: app/src/main/java/me/rerere/rikkahub/navigation/AppNavigation.kt\r\n  - 添加World Book和Memory Table页面路由\r\n  - 集成到现有导航系统\r\n  - Purpose: 将新页面集成到应用导航结构中\r\n  - _Leverage: app/src/main/java/me/rerere/rikkahub/navigation/NavigationDestinations.kt_\r\n  - _Requirements: 3.4_\r\n  - _Prompt: Role: Android Navigation Architect with Navigation Compose expertise | Task: Update AppNavigation to include World Book and Memory Table routes, integrating seamlessly with existing navigation structure | Restrictions: Must follow existing navigation patterns, maintain deep link compatibility, ensure proper back navigation | Success: Navigation works correctly for all new pages, integrates smoothly with existing navigation, maintains consistent user experience_\r\n\r\n- [ ] 4.2 创建可复用的表格编辑组件\r\n  - File: app/src/main/java/me/rerere/rikkahub/ui/components/TableEditor.kt\r\n  - 实现通用的动态表格编辑组件\r\n  - 支持拖拽排序和批量操作\r\n  - Purpose: 提供可复用的表格编辑UI组件\r\n  - _Leverage: app/src/main/java/me/rerere/rikkahub/ui/components/FormItem.kt_\r\n  - _Requirements: 2.4, 3.2, 3.3_\r\n  - _Prompt: Role: Android Compose Component Architect | Task: Create reusable TableEditor component with drag-and-drop, batch operations, and dynamic structure support, following existing component patterns | Restrictions: Must be highly reusable, handle various data types, maintain performance with large datasets | Success: Component is reusable across features, provides smooth editing experience, handles all table operations efficiently_\r\n\r\n- [ ] 4.3 集成AI聊天上下文注入\r\n  - File: app/src/main/java/me/rerere/rikkahub/ui/pages/chat/ChatViewModel.kt\r\n  - 修改聊天ViewModel以支持World Book和Memory Table注入\r\n  - 添加自动上下文匹配逻辑\r\n  - Purpose: 在AI对话中自动注入相关知识库内容\r\n  - _Leverage: app/src/main/java/me/rerere/rikkahub/service/WorldBookMatcher.kt_\r\n  - _Requirements: 1.5, 2.5, 4.1_\r\n  - _Prompt: Role: AI Integration Architect | Task: Integrate World Book and Memory Table context injection into ChatViewModel, implementing automatic context matching and injection | Restrictions: Must maintain chat performance, provide injection control to users, handle injection failures gracefully | Success: Context injection works seamlessly in chats, improves AI response quality, provides user control over injection_\r\n\r\n## Phase 5: 测试和优化\r\n\r\n- [ ] 5.1 创建数据层单元测试\r\n  - File: app/src/test/java/me/rerere/rikkahub/data/repository/\r\n  - 测试Repository层和数据库操作\r\n  - 验证数据一致性和错误处理\r\n  - Purpose: 确保数据层的可靠性和正确性\r\n  - _Leverage: app/src/test/java/me/rerere/rikkahub/utils/DatabaseTestUtils.kt_\r\n  - _Requirements: 所有数据层需求_\r\n  - _Prompt: Role: Android Testing Engineer with Room and JUnit expertise | Task: Create comprehensive unit tests for Repository layer and database operations, covering all CRUD scenarios and edge cases | Restrictions: Must use proper test doubles, test error conditions, ensure test isolation and reliability | Success: All data operations are thoroughly tested, tests catch regressions, code coverage meets quality standards_\r\n\r\n- [ ] 5.2 创建UI层集成测试\r\n  - File: app/src/test/java/me/rerere/rikkahub/ui/pages/\r\n  - 测试Compose UI组件和ViewModel交互\r\n  - 验证用户交互流程\r\n  - Purpose: 确保UI层的功能正确性和用户体验\r\n  - _Leverage: app/src/test/java/me/rerere/rikkahub/utils/ComposeTestUtils.kt_\r\n  - _Requirements: 所有UI层需求_\r\n  - _Prompt: Role: Android Compose Testing Specialist | Task: Create integration tests for Compose UI components and ViewModels, covering all user interaction flows and state changes | Restrictions: Must use Compose testing best practices, simulate real user interactions, test both happy path and error scenarios | Success: UI tests verify all user flows work correctly, state management is properly tested, tests are reliable and maintainable_\r\n\r\n- [ ] 5.3 性能优化和内存泄漏检测\r\n  - File: 整个项目的性能分析\r\n  - 优化关键路径性能\r\n  - 检测和修复内存泄漏\r\n  - Purpose: 确保应用性能和稳定性\r\n  - _Leverage: app/src/main/java/me/rerere/rikkahub/utils/PerformanceMonitor.kt_\r\n  - _Requirements: 4.1, 4.2_\r\n  - _Prompt: Role: Android Performance Engineer | Task: Conduct comprehensive performance analysis and optimization, focusing on database queries, UI rendering, and memory usage | Restrictions: Must maintain functionality while improving performance, follow Android performance best practices, ensure no memory leaks | Success: Application meets all performance targets, memory usage is optimized, no memory leaks detected_\r\n\r\n## Phase 6: 文档和部署准备\r\n\r\n- [ ] 6.1 更新用户文档和帮助内容\r\n  - File: app/src/main/res/values-*/strings.xml\r\n  - 添加World Book和Memory Table功能的用户说明\r\n  - 创建帮助文档和工具提示\r\n  - Purpose: 为用户提供清晰的功能说明和使用指导\r\n  - _Leverage: app/src/main/res/values/strings_help.xml_\r\n  - _Requirements: 所有用户界面需求_\r\n  - _Prompt: Role: Technical Writer with Android localization expertise | Task: Create comprehensive user documentation for World Book and Memory Table features, including help text and tooltips | Restrictions: Must follow existing documentation style, ensure clarity and accuracy, support multiple languages | Success: Documentation is clear and helpful, users can easily understand and use new features_\r\n\r\n- [ ] 6.2 代码审查和质量保证\r\n  - File: 所有新增和修改的代码文件\r\n  - 进行代码审查和质量检查\r\n  - 确保代码符合项目标准\r\n  - Purpose: 保证代码质量和可维护性\r\n  - _Leverage: app/.kotlinlint.yml_\r\n  - _Requirements: 所有代码质量要求_\r\n  - _Prompt: Role: Senior Android Developer with code review expertise | Task: Conduct comprehensive code review and quality assurance for all new code, ensuring adherence to project standards | Restrictions: Must maintain backward compatibility, follow all coding standards, ensure no security vulnerabilities | Success: Code meets all quality standards, is well-documented, follows project conventions, ready for production_\r\n\r\n- [ ] 6.3 最终集成测试和发布准备\r\n  - File: 整个应用集成测试\r\n  - 执行端到端测试流程\r\n  - 准备发布版本\r\n  - Purpose: 确保所有功能正确集成，应用可以发布\r\n  - _Leverage: app/build.gradle.kts_\r\n  - _Requirements: 所有功能和质量要求_\r\n  - _Prompt: Role: Android Release Engineer | Task: Perform final integration testing and release preparation, ensuring all features work together correctly and app is ready for production | Restrictions: Must ensure no regressions, verify all critical paths work, prepare proper release notes | Success: Application is fully tested and ready for release, all features work correctly, release documentation is complete_",
  "fileStats": {
    "size": 17056,
    "lines": 193,
    "lastModified": "2025-11-07T02:44:14.699Z"
  },
  "comments": []
}