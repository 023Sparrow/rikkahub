{
  "id": "snapshot_1762175990556_3qlkf62da",
  "approvalId": "approval_1762175990543_n0mc9rgbg",
  "approvalTitle": "Tasks Document Approval",
  "version": 1,
  "timestamp": "2025-11-03T13:19:50.556Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Tasks Document: World Book and Memory Table Integration\r\n\r\n- [ ] 1. Configure dependency injection in AppModule\r\n  - File: app/src/main/java/me/rerere/rikkahub/di/AppModule.kt\r\n  - Add WorldBookMatcher and WorldBookInjector as singletons\r\n  - Purpose: Enable service injection throughout application\r\n  - _Leverage: existing AppModule.kt pattern, WorldBookMatcher service, WorldBookInjector service\r\n  - _Requirements: 1.1\r\n  - _Prompt: Role: Android/Kotlin Developer specializing in dependency injection and Koin | Task: Configure dependency injection in AppModule.kt following requirement 1.1, registering WorldBookMatcher and WorldBookInjector as singletons using existing patterns | Restrictions: Must follow existing Koin configuration patterns, do not modify repository DI configuration, maintain singleton lifecycle | Success: Services are properly registered and resolvable, no circular dependencies, follows existing architecture patterns\r\n\r\n- [ ] 2. Integrate world book functionality in ChatService\r\n  - File: app/src/main/java/me/rerere/rikkahub/service/ChatService.kt\r\n  - Add constructor parameters for worldBookRepository, worldBookMatcher, worldBookInjector\r\n  - Modify handleMessageComplete() to fetch, match, and inject world book entries\r\n  - Pass injected messages to generationHandler.generateText()\r\n  - Purpose: Enable automatic world book context injection during chat\r\n  - _Leverage: existing ChatService.kt pattern, WorldBookRepository, WorldBookMatcher, WorldBookInjector, Assistant model\r\n  - _Requirements: 2.1, 2.2\r\n  - _Prompt: Role: Android Developer with expertise in MVVM architecture and chat systems | Task: Integrate world book functionality in ChatService following requirements 2.1 and 2.2, modifying handleMessageComplete() method to fetch active entries, match against context, and inject into messages before generation | Restrictions: Must not break existing chat functionality, maintain async/await patterns, ensure proper error handling with graceful degradation | Success: World book matching and injection works correctly, performance is maintained, errors do not break chat flow\r\n\r\n- [ ] 3. Implement MemoryTableQueryService\r\n  - File: app/src/main/java/me/rerere/rikkahub/service/MemoryTableQueryService.kt\r\n  - Implement searchTables() method for keyword-based search\r\n  - Add formatTableAsMarkdown() for AI consumption\r\n  - Add exportTableAsCSV() and importTableFromCSV() methods\r\n  - Purpose: Provide structured data querying and export/import functionality\r\n  - _Leverage: MemoryTableRepository, MemoryTable entity, MemoryTableRow entity, CSV utilities, Markdown utilities\r\n  - _Requirements: 7.1, 7.2, 7.3\r\n  - _Prompt: Role: Android/Kotlin Developer with expertise in data processing and formatting | Task: Implement MemoryTableQueryService following requirements 7.1, 7.2, and 7.3, creating methods for searching, formatting as Markdown, and exporting/importing CSV data | Restrictions: Must validate all inputs, handle large datasets efficiently, maintain data integrity during import/export | Success: All query methods work correctly, formatting produces valid output, import/export handles validation errors gracefully\r\n\r\n- [ ] 4. Register MemoryTableQueryService in AppModule\r\n  - File: app/src/main/java/me/rerere/rikkahub/di/AppModule.kt\r\n  - Add MemoryTableQueryService to DI configuration\r\n  - Purpose: Enable service injection for memory table queries\r\n  - _Leverage: existing AppModule.kt pattern, MemoryTableQueryService\r\n  - _Requirements: 7.1\r\n  - _Prompt: Role: Android/Kotlin Developer specializing in dependency injection | Task: Register MemoryTableQueryService in AppModule following requirement 7.1, configuring as singleton using existing patterns | Restrictions: Must follow existing Koin patterns, no circular dependencies, proper lifecycle management | Success: Service is properly registered and resolvable, no circular dependencies, follows architecture patterns\r\n\r\n- [ ] 5. Update ChatService constructor and dependency injection\r\n  - File: app/src/main/java/me/rerere/rikkahub/di/AppModule.kt\r\n  - Update ChatService constructor to include new dependencies\r\n  - Add MemoryTableQueryService to ChatService if needed for AI tools\r\n  - Purpose: Ensure ChatService has all required dependencies\r\n  - _Leverage: existing ChatService constructor, AppModule DI configuration\r\n  - _Requirements: 2.1, 7.1\r\n  - _Prompt: Role: Android/Kotlin Developer with dependency injection expertise | Task: Update ChatService constructor and DI configuration following requirements 2.1 and 7.1, adding new dependencies to constructor and DI registration | Restrictions: Must maintain existing constructor signature compatibility, follow Koin patterns, no breaking changes | Success: All dependencies are properly injected, no DI resolution errors, follows existing patterns\r\n\r\n- [ ] 6. Implement WorldBookViewModel\r\n  - File: app/src/main/java/me/rerere/rikkahub/ui/viewmodel/WorldBookViewModel.kt\r\n  - Update existing implementation if needed (already exists but commented)\r\n  - Add state management for entries, search query, assistant ID\r\n  - Implement CRUD operations with proper error handling\r\n  - Purpose: Manage UI state for world book management\r\n  - _Leverage: existing WorldBookViewModel implementation, WorldBookRepository, StateFlow patterns\r\n  - _Requirements: 3.1, 3.2, 3.3\r\n  - _Prompt: Role: Android Developer with expertise in MVVM and Jetpack Compose state management | Task: Implement or update WorldBookViewModel following requirements 3.1, 3.2, and 3.3, managing state for entries list, search, and CRUD operations | Restrictions: Must use StateFlow/MutableStateFlow, handle async operations properly, implement proper error handling | Success: ViewModel manages state correctly, all operations work with proper loading/error states, follows MVVM patterns\r\n\r\n- [ ] 7. Implement MemoryTableViewModel\r\n  - File: app/src/main/java/me/rerere/rikkahub/ui/viewmodel/MemoryTableViewModel.kt\r\n  - Create new ViewModel for memory table management\r\n  - Add state for tables list, selected table, rows, assistant ID\r\n  - Implement CRUD operations with reactive updates\r\n  - Purpose: Manage UI state for memory table management\r\n  - _Leverage: existing ViewModel patterns from WorldBookViewModel, MemoryTableRepository, StateFlow\r\n  - _Requirements: 5.1, 5.2\r\n  - _Prompt: Role: Android Developer with MVVM and state management expertise | Task: implement MemoryTableViewModel following requirements 5.1 and 5.2, managing state for tables list, selection, rows, and CRUD operations | Restrictions: Must follow existing ViewModel patterns, use StateFlow, maintain data consistency | Success: ViewModel properly manages all state, operations update state reactively, follows architecture patterns\r\n\r\n- [ ] 8. Create WorldBookManagementPage composable\r\n  - File: app/src/main/java/me/rerere/rikkahub/ui/pages/worldbook/WorldBookManagementPage.kt\r\n  - Implement list view with search functionality\r\n  - Add floating action button for creating new entries\r\n  - Implement entry cards with actions (edit, toggle enabled, delete)\r\n  - Purpose: Provide UI for managing world book entries\r\n  - _Leverage: existing Compose pages like AssistantPage.kt, Material 3 components, WorldBookViewModel\r\n  - _Requirements: 3.1, 3.2, 3.3, 3.5, 3.6, 3.7\r\n  - _Prompt: Role: Android/Jetpack Compose Developer with UI/UX expertise | Task: Create WorldBookManagementPage composable following requirements 3.1, 3.2, 3.3, 3.5, 3.6, and 3.7, implementing list view with search, FAB, entry cards with actions | Restrictions: Must use Material 3 components, follow existing page patterns, implement proper navigation, handle empty states | Success: Page displays entries correctly, search works, all actions function properly, follows design system\r\n\r\n- [ ] 9. Create WorldBookEditorPage composable\r\n  - File: app/src/main/java/me/rerere/rikkahub/ui/pages/worldbook/WorldBookEditorPage.kt\r\n  - Implement form with all world book fields (title, keywords, content, etc.)\r\n  - Add tag-based keyword input with autocomplete\r\n  - Add toggle switches for advanced settings (regex, constant, selective, etc.)\r\n  - Add priority slider and injection position selector\r\n  - Implement save/cancel actions with validation\r\n  - Purpose: Provide UI for creating and editing world book entries\r\n  - _Leverage: existing Compose forms, Material 3 components, validation patterns\r\n  - _Requirements: 4.1, 4.2, 4.3, 4.4, 4.5, 4.6, 4.7, 4.8\r\n  - _Prompt: Role: Android/Compose Developer with form design expertise | Task: Create WorldBookEditorPage composable following requirements 4.1 through 4.8, implementing comprehensive form with all fields, tag input, toggles, and validation | Restrictions: Must use Material 3, implement proper validation, handle keyboard input correctly, provide good UX | Success: All fields work correctly, validation prevents invalid data, form is intuitive and user-friendly\r\n\r\n- [ ] 10. Create MemoryTableManagementPage composable\r\n  - File: app/src/main/java/me/rerere/rikkahub/ui/pages/memorytable/MemoryTableManagementPage.kt\r\n  - Implement list view for tables with search\r\n  - Add FAB for creating new tables\r\n  - Implement table cards with actions (edit, delete)\r\n  - Purpose: Provide UI for managing memory tables\r\n  - _Leverage: existing Compose pages like WorldBookManagementPage, Material 3, MemoryTableViewModel\r\n  - _Requirements: 5.1, 5.2, 5.3, 5.5, 5.6\r\n  - _Prompt: Role: Android/Compose Developer with list UI expertise | Task: Create MemoryTableManagementPage composable following requirements 5.1, 5.2, 5.3, 5.5, and 5.6, implementing table list with search, FAB, and actions | Restrictions: Must follow existing page patterns, Material 3 components, proper navigation | Success: Page displays tables correctly, search works, actions function properly, consistent with app design\r\n\r\n- [ ] 11. Create MemoryTableEditorPage composable\r\n  - File: app/src/main/java/me/rerere/rikkahub/ui/pages/memorytable/MemoryTableEditorPage.kt\r\n  - Implement table editor with name/description fields\r\n  - Add column header management (add/remove/rename)\r\n  - Implement Excel-like row editing interface\r\n  - Add import from CSV and export to CSV/Markdown buttons\r\n  - Add save/cancel actions\r\n  - Purpose: Provide UI for creating and editing memory tables\r\n  - _Leverage: existing Compose forms, Reorderable library (in dependencies), Material 3\r\n  - _Requirements: 5.4, 7.3\r\n  - _Prompt: Role: Android/Compose Developer with data grid/editing expertise | Task: Create MemoryTableEditorPage composable following requirements 5.4 and 7.3, implementing comprehensive table editor with column/row management and import/export | Restrictions: Must handle large tables efficiently, implement proper scrolling, use Reorderable for row reordering | Success: Table editing works smoothly, import/export functions correctly, handles large datasets well\r\n\r\n- [ ] 12. Add knowledge base button to ChatPage\r\n  - File: app/src/main/java/me/rerere/rikkahub/ui/pages/chat/ChatPage.kt\r\n  - Add knowledge base button to TopAppBar actions\r\n  - Implement dropdown/modal with World Book and Memory Table options\r\n  - Add navigation to respective management pages\r\n  - Purpose: Provide quick access to knowledge base management\r\n  - _Leverage: existing ChatPage TopAppBar, Material 3 components, navigation patterns\r\n  - _Requirements: 6.1, 6.2, 6.3, 6.4, 6.5\r\n  - _Prompt: Role: Android/Compose Developer with navigation and UI integration expertise | Task: Add knowledge base button to ChatPage following requirements 6.1 through 6.5, implementing TopAppBar button with navigation menu | Restrictions: Must not interfere with existing actions, maintain design consistency, handle navigation properly | Success: Button is visible and accessible, navigation works correctly, maintains app design consistency\r\n\r\n- [ ] 13. Add world book and memory table settings to AssistantDetailPage\r\n  - File: app/src/main/java/me/rerere/rikkahub/ui/pages/assistant/detail/AssistantDetailPage.kt\r\n  - Add toggle switches for enableWorldBook and enableMemoryTable\r\n  - Add configuration fields for world book settings (context size, history messages, format style)\r\n  - Add world book tab to existing tab layout\r\n  - Purpose: Allow users to configure knowledge base features per assistant\r\n  - _Leverage: existing AssistantDetailPage tab layout, Material 3 toggles/sliders\r\n  - _Requirements: 8.1, 8.2, 8.3, 8.4, 8.5\r\n  - _Prompt: Role: Android/Compose Developer with settings UI expertise | Task: Add knowledge base settings to AssistantDetailPage following requirements 8.1 through 8.5, implementing toggles and configuration fields | Restrictions: Must follow existing tab/layout patterns, persist settings correctly, validate inputs | Success: Settings UI integrates seamlessly, all toggles work, settings are saved and applied correctly\r\n\r\n- [ ] 14. Enable navigation routes in RouteActivity\r\n  - File: app/src/main/java/me/rerere/rikkahub/RouteActivity.kt\r\n  - Uncomment/comment out world book and memory table composable routes\r\n  - Add knowledge base routes to NavHost\r\n  - Purpose: Enable navigation to knowledge base screens\r\n  - _Leverage: existing RouteActivity navigation setup, Screen definitions\r\n  - _Requirements: 3.1, 5.1, 6.1\r\n  - _Prompt: Role: Android Developer with navigation architecture expertise | Task: Enable navigation routes in RouteActivity following requirements 3.1, 5.1, and 6.1, adding composable routes to NavHost for world book and memory table screens | Restrictions: Must follow existing route patterns, maintain proper argument passing, test navigation flows | Success: All routes navigate correctly, arguments are passed properly, navigation back works as expected\r\n\r\n- [ ] 15. Clean up commented UI code\r\n  - Files: app/src/main/java/me/rerere/rikkahub/ui/fragment/WorldBookFragment.kt, app/src/main/java/me/rerere/rikkahub/ui/fragment/MemoryTableFragment.kt, app/src/main/java/me/rerere/rikkahub/ui/adapter/MemoryTableEditorAdapter.kt, app/src/main/java/me/rerere/rikkahub/ui/viewmodel/MemoryTableEditorViewModel.kt\r\n  - Remove commented/legacy code that uses Android View system\r\n  - Remove any unused imports and dependencies\r\n  - Purpose: Maintain clean codebase without legacy code\r\n  - _Leverage: existing file structure, git history if needed\r\n  - _Requirements: Code Quality\r\n  - _Prompt: Role: Android Developer with code cleanup and refactoring expertise | Task: Clean up commented UI code in legacy Fragment/DataBinding files, removing unused code that might cause confusion | Restrictions: Must not remove any functionality, backup important code patterns in comments, verify no broken references | Success: Legacy code is removed or properly archived, no compilation warnings, codebase is clean and maintainable\r\n\r\n- [ ] 16. Update Assistant model to use MemoryTableQueryService\r\n  - File: app/src/main/java/me/rerere/rikkahub/data/model/Assistant.kt\r\n  - Verify all world book and memory table fields are present and correct\r\n  - Add any missing configuration fields if needed\r\n  - Purpose: Ensure Assistant model supports all required configurations\r\n  - _Leverage: existing Assistant.kt implementation, requirements specification\r\n  - _Requirements: 8.1, 8.2, 8.3, 8.4, 8.5\r\n  - _Prompt: Role: Android/Kotlin Developer with data model expertise | Task: Verify and update Assistant model following requirements 8.1 through 8.5, ensuring all world book and memory table configuration fields are present and properly typed | Restrictions: Must maintain backward compatibility, use correct serialization annotations, follow existing patterns | Success: Model includes all required fields, serialization works correctly, backward compatibility maintained\r\n\r\n- [ ] 17. Integrate MemoryTableQueryService with AI tools\r\n  - File: app/src/main/java/me/rerere/rikkahub/data/ai/tools/LocalTools.kt\r\n  - Add memory table query tool to local tools list\r\n  - Implement tool definition and execution logic\r\n  - Purpose: Enable AI assistants to query memory tables via tools\r\n  - _Leverage: existing LocalTools.kt pattern, MemoryTableQueryService\r\n  - _Requirements: 7.1\r\n  - _Prompt: Role: Android/Kotlin Developer with AI integration expertise | Task: Integrate MemoryTableQueryService with AI tools following requirement 7.1, adding memory table query as a local tool | Restrictions: Must follow existing tool patterns, implement proper tool metadata, handle tool execution errors | Success: Tool is properly registered, AI can query tables, tool execution handles errors gracefully\r\n\r\n- [ ] 18. Test world book integration in ChatService\r\n  - File: app/src/test/java/me/rerere/rikkahub/service/ChatServiceWorldBookTest.kt (create new)\r\n  - Write unit tests for world book matching and injection\r\n  - Test with various assistant configurations\r\n  - Test error handling and graceful degradation\r\n  - Purpose: Ensure ChatService integration works correctly\r\n  - _Leverage: existing test patterns, ChatService, WorldBookMatcher, WorldBookInjector\r\n  - _Requirements: 2.1, 2.2\r\n  - _Prompt: Role: QA Engineer with unit testing expertise | Task: Create comprehensive unit tests for ChatService world book integration covering requirements 2.1 and 2.2, testing various scenarios and configurations | Restrictions: Must mock dependencies appropriately, test both success and failure cases, maintain test isolation | Success: All integration scenarios are tested, tests pass reliably, test coverage is adequate\r\n\r\n- [ ] 19. Test MemoryTableQueryService\r\n  - File: app/src/test/java/me/rerere/rikkahub/service/MemoryTableQueryServiceTest.kt (create new)\r\n  - Write tests for search, formatting, import, export methods\r\n  - Test with various table sizes and data types\r\n  - Test validation and error handling\r\n  - Purpose: Ensure MemoryTableQueryService works correctly\r\n  - _Leverage: existing test patterns, MemoryTableQueryService\r\n  - _Requirements: 7.1, 7.2, 7.3\r\n  - _Prompt: Role: QA Engineer with service testing expertise | Task: Create comprehensive unit tests for MemoryTableQueryService covering requirements 7.1, 7.2, and 7.3, testing search, formatting, import, and export functionality | Restrictions: Must test with realistic data, verify output formats are correct, test error scenarios | Success: All methods are thoroughly tested, output formats are validated, error handling works correctly\r\n\r\n- [ ] 20. Run full application build and tests\r\n  - Execute: ./gradlew build\r\n  - Execute: ./gradlew test\r\n  - Fix any compilation errors or test failures\r\n  - Purpose: Ensure all changes integrate correctly\r\n  - _Leverage: existing build system, test infrastructure\r\n  - _Requirements: All\r\n  - _Prompt: Role: Build Engineer with CI/CD expertise | Task: Run full application build and test suite, fixing any issues that arise | Restrictions: Must not break existing functionality, maintain test pass rates, ensure build stability | Success: Build completes successfully, all tests pass, no regressions introduced\r\n\r\n- [ ] 21. Create usage documentation\r\n  - File: docs/world-book-usage-guide.md\r\n  - Document how to use world book features\r\n  - Document how to use memory table features\r\n  - Include examples and best practices\r\n  - Purpose: Provide user documentation for new features\r\n  - _Leverage: existing documentation patterns, feature specifications\r\n  - _Requirements: User Documentation\r\n  - _Prompt: Role: Technical Writer with Android app documentation expertise | Task: Create comprehensive usage documentation for world book and memory table features, including examples and best practices | Restrictions: Must be clear and concise, include screenshots/examples, follow existing doc patterns | Success: Documentation is complete and clear, covers all user scenarios, follows style guide\r\n\r\n- [ ] 22. Final code review and cleanup\r\n  - Review all implemented code for quality and consistency\r\n  - Ensure all files follow project conventions\r\n  - Remove any debug code or TODO comments\r\n  - Verify all features work end-to-end\r\n  - Purpose: Ensure high code quality and maintainability\r\n  - _Leverage: existing code review standards, project conventions\r\n  - _Requirements: Code Quality\r\n  - _Prompt: Role: Senior Android Developer with code review and quality assurance expertise | Task: Perform comprehensive code review and cleanup, ensuring all code meets quality standards and follows conventions | Restrictions: Must maintain functionality, ensure performance, verify security considerations | Success: Code is clean and maintainable, all features work end-to-end, meets quality standards\r\n\r\n## Implementation Notes\r\n\r\n### Task Dependencies\r\n- Task 1 must complete before Task 2\r\n- Task 2 must complete before Task 5\r\n- Tasks 3-4 can be done in parallel\r\n- Tasks 6-7 can be done in parallel\r\n- Tasks 8-11 require Tasks 6-7 to be complete\r\n- Task 12 requires Tasks 8-11 to be complete\r\n- Task 13 can be done in parallel with Tasks 8-11\r\n- Task 14 requires Tasks 8-11 to be complete\r\n- Tasks 15-22 can be done after core implementation\r\n\r\n### File Organization\r\nAll new files should be created in the appropriate package structure following existing conventions:\r\n- Services: `app/src/main/java/me/rerere/rikkahub/service/`\r\n- ViewModels: `app/src/main/java/me/rerere/rikkahub/ui/viewmodel/`\r\n- UI Pages: `app/src/main/java/me/rerere/rikkahub/ui/pages/worldbook/` and `app/src/main/java/me/rerere/rikkahub/ui/pages/memorytable/`\r\n- Tests: `app/src/test/java/me/rerere/rikkahub/service/`\r\n\r\n### Code Style\r\n- Follow existing Kotlin code style\r\n- Use meaningful variable and function names\r\n- Add KDoc comments for public APIs\r\n- Maintain consistent formatting\r\n- Follow Material 3 design guidelines for UI\r\n",
  "fileStats": {
    "size": 21695,
    "lines": 243,
    "lastModified": "2025-11-03T13:19:37.447Z"
  },
  "comments": []
}