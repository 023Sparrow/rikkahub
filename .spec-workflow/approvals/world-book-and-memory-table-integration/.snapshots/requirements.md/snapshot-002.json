{
  "id": "snapshot_1762175596003_13druu2mu",
  "approvalId": "approval_1762175577895_l0pgh2f89",
  "approvalTitle": "Requirements Document Approval",
  "version": 2,
  "timestamp": "2025-11-03T13:13:16.003Z",
  "trigger": "approved",
  "status": "pending",
  "content": "# Requirements Document: World Book and Memory Table Integration\r\n\r\n## Introduction\r\n\r\nThis feature completes the integration of World Book (similar to SillyTavern World Info) and Memory Table (similar to memory enhancement) functionality into the RikkaHub Android application. These features provide AI-powered contextual knowledge injection and structured data management capabilities, enhancing the conversational AI experience by automatically matching and injecting relevant information based on conversation context.\r\n\r\nThe World Book feature allows users to create searchable knowledge entries with keywords that automatically trigger context injection during AI conversations. The Memory Table feature provides spreadsheet-like structured data storage that can be queried by AI assistants.\r\n\r\n## Alignment with Product Vision\r\n\r\nThis feature aligns with RikkaHub's vision of providing a sophisticated AI chat platform by:\r\n- Enhancing AI responses with contextual knowledge injection\r\n- Providing structured data management for character/assistant information\r\n- Offering advanced customization options for different AI personalities\r\n- Supporting multimodal and complex AI use cases\r\n\r\n## Requirements\r\n\r\n### Requirement 1: Dependency Injection Integration\r\n\r\n**User Story:** As a developer, I want to integrate WorldBookMatcher and WorldBookInjector services into the application's dependency injection system, so that they can be properly managed and accessed throughout the application.\r\n\r\n#### Acceptance Criteria\r\n\r\n1. WHEN ChatService is instantiated THEN it SHALL receive WorldBookMatcher and WorldBookInjector via constructor injection\r\n2. IF AppModule.kt is updated with new service registrations THEN Koin SHALL successfully resolve these dependencies\r\n3. WHEN WorldBookRepository is accessed THEN it SHALL provide active world book entries for the current assistant\r\n4. IF any DI configuration is missing THEN the application SHALL fail fast at startup with clear error messages\r\n\r\n### Requirement 2: ChatService Integration with World Book\r\n\r\n**User Story:** As a user, I want world book entries to be automatically matched and injected into my AI conversations based on keywords, so that I receive more contextual and accurate responses.\r\n\r\n#### Acceptance Criteria\r\n\r\n1. WHEN a message is sent to the AI AND the assistant has enableWorldBook=true THEN the system SHALL match active world book entries using the current message and recent conversation history\r\n2. IF world book entries are matched THEN they SHALL be injected as SYSTEM role messages at the position specified by injectionPosition (0=beginning, 1=end)\r\n3. WHEN multiple entries match THEN they SHALL be sorted by priority (higher first) and deduplicated\r\n4. IF recursive matching is enabled THEN matched entry content SHALL trigger additional matches up to the configured depth\r\n5. WHEN context size limit is reached THEN excess content SHALL be truncated with appropriate markers\r\n6. IF world book is disabled for an assistant THEN no matching or injection SHALL occur\r\n\r\n### Requirement 3: World Book Management UI (Jetpack Compose)\r\n\r\n**User Story:** As a user, I want to manage world book entries through an intuitive UI, so that I can easily create, edit, and organize my knowledge base.\r\n\r\n#### Acceptance Criteria\r\n\r\n1. WHEN the user navigates to World Book management THEN a list of all entries for the current assistant SHALL be displayed\r\n2. WHEN the user taps the add button THEN a world book editor SHALL open with empty fields\r\n3. WHEN the user selects an entry THEN the editor SHALL populate with existing values for editing\r\n4. IF the user enters keywords and content THEN the entry SHALL be saved with proper validation\r\n5. WHEN the user searches for entries THEN results SHALL filter by title, keywords, or content\r\n6. IF the user toggles an entry's enabled status THEN the change SHALL persist immediately\r\n7. WHEN the user deletes an entry THEN a confirmation dialog SHALL appear before deletion\r\n\r\n### Requirement 4: World Book Editor with Advanced Features\r\n\r\n**User Story:** As a power user, I want to configure advanced world book settings like regex matching, recursion depth, and priority, so that I can fine-tune the knowledge injection behavior.\r\n\r\n#### Acceptance Criteria\r\n\r\n1. WHEN editing an entry THEN the user SHALL be able to add/remove multiple keywords\r\n2. IF useRegex is enabled THEN keywords SHALL be treated as regular expressions during matching\r\n3. WHEN secondary keywords are configured AND isSelective=true THEN ALL secondary keywords MUST match (AND logic)\r\n4. WHEN secondary keywords are configured AND isSelective=false THEN ANY secondary keyword MAY match (OR logic)\r\n5. IF isConstant is enabled THEN the entry SHALL always be injected regardless of keywords\r\n6. WHEN priority is set THEN entries SHALL be ordered by this value during injection\r\n7. IF excludeRecursion is enabled THEN this entry's content SHALL NOT trigger recursive matches\r\n8. WHEN injectionPosition is set THEN the formatted content SHALL be inserted at the specified location\r\n\r\n### Requirement 5: Memory Table Management UI\r\n\r\n**User Story:** As a user, I want to create and manage structured data tables, so that I can organize character information, story elements, or any tabular data for AI reference.\r\n\r\n#### Acceptance Criteria\r\n\r\n1. WHEN the user navigates to Memory Table management THEN a list of all tables for the current assistant SHALL be displayed\r\n2. WHEN the user creates a new table THEN they SHALL be able to define table name, description, and column headers\r\n3. WHEN editing a table THEN the user SHALL be able to add/remove rows and edit cell values\r\n4. IF the user changes column headers THEN existing row data SHALL be preserved or migrated appropriately\r\n5. WHEN the user deletes a table THEN all associated rows SHALL also be deleted\r\n6. IF enableMemoryTable is true for an assistant THEN the table SHALL be available as a queryable resource\r\n7. WHEN searching tables THEN results SHALL filter by table name or description\r\n\r\n### Requirement 6: Chat Interface Knowledge Base Access\r\n\r\n**User Story:** As a user, I want quick access to world book and memory table management from the chat interface, so that I can efficiently manage my knowledge base while conversing.\r\n\r\n#### Acceptance Criteria\r\n\r\n1. WHEN the user views the chat interface THEN a knowledge base button SHALL be visible in the top app bar\r\n2. WHEN the user taps the knowledge base button THEN a navigation menu SHALL appear with options for World Book and Memory Table\r\n3. IF the user selects World Book management THEN they SHALL be taken to the world book list filtered for the current assistant\r\n4. IF the user selects Memory Table management THEN they SHALL be taken to the memory table list filtered for the current assistant\r\n5. WHEN navigating back from knowledge base screens THEN the user SHALL return to the chat interface\r\n\r\n### Requirement 7: Memory Table Query Service\r\n\r\n**User Story:** As an AI assistant, I want to access memory table data through tool calls, so that I can provide more accurate and contextually relevant information based on structured data.\r\n\r\n#### Acceptance Criteria\r\n\r\n1. WHEN an AI assistant needs table data THEN it SHALL be able to query tables by keywords\r\n2. IF a query matches table rows THEN the results SHALL be formatted as structured data (Markdown or JSON)\r\n3. WHEN exporting a table THEN the user SHALL be able to choose CSV or Markdown format\r\n4. IF importing table data THEN the system SHALL validate CSV format and create/update tables accordingly\r\n5. WHEN table data is queried THEN the response SHALL include column headers and matching row data\r\n6. IF no matches are found THEN an appropriate empty result SHALL be returned\r\n\r\n### Requirement 8: Assistant Model Integration\r\n\r\n**User Story:** As a user, I want to enable/disable world book and memory table features per assistant, so that different AI personalities can have different knowledge management capabilities.\r\n\r\n#### Acceptance Criteria\r\n\r\n1. WHEN editing an assistant THEN the user SHALL see toggle switches for enableWorldBook and enableMemoryTable\r\n2. IF enableWorldBook is true THEN world book matching SHALL be active for this assistant\r\n3. IF enableMemoryTable is true THEN memory table querying SHALL be available for this assistant\r\n4. WHEN world book settings are configured THEN the system SHALL apply context size, history message count, and format style preferences\r\n5. IF settings are changed THEN they SHALL be immediately saved to the assistant configuration\r\n\r\n## Non-Functional Requirements\r\n\r\n### Code Architecture and Modularity\r\n- **Single Responsibility Principle**: Each service (WorldBookMatcher, WorldBookInjector, MemoryTableQueryService) SHALL have a single, well-defined purpose\r\n- **Modular Design**: UI components, ViewModels, and services SHALL be isolated and reusable across the application\r\n- **Dependency Management**: Use Koin for DI, minimizing interdependencies between modules\r\n- **Clear Interfaces**: Define clean contracts between UI, ViewModels, and data layers following MVVM pattern\r\n- **Jetpack Compose Integration**: All UI SHALL use Compose, replacing any legacy Android View implementations\r\n\r\n### Performance\r\n- World book matching SHALL complete within 100ms for typical workloads (≤50 entries)\r\n- Memory table queries SHALL return results within 50ms for tables with ≤1000 rows\r\n- UI interactions SHALL maintain 60fps during list scrolling and editing\r\n- Database queries SHALL use appropriate indexes and LIMIT clauses for large datasets\r\n\r\n### Security\r\n- World book content SHALL be sanitized before injection to prevent prompt injection attacks\r\n- User data in tables SHALL be encrypted at rest using Android Keystore\r\n- No sensitive data (API keys, passwords) SHALL be stored in world book or memory table entries\r\n- All data operations SHALL follow principle of least privilege\r\n\r\n### Reliability\r\n- Database operations SHALL use transactions to ensure data consistency\r\n- Failed world book injection SHALL not break the chat flow (graceful degradation)\r\n- All async operations SHALL have proper error handling and user feedback\r\n- Data migrations SHALL preserve existing data and maintain compatibility\r\n\r\n### Usability\r\n- World book editor SHALL support keyword tag-based input with autocomplete\r\n- Memory table editor SHALL provide Excel-like editing experience\r\n- All forms SHALL have inline validation with clear error messages\r\n- Keyboard shortcuts SHALL be supported for power users (Ctrl+S for save)\r\n- Offline capability: All features SHALL work without internet connectivity\r\n\r\n## Technical Context\r\n\r\nBased on existing implementation:\r\n- Database layer (WorldBookEntry, MemoryTable, MemoryTableRow) is complete\r\n- Repository layer (WorldBookRepository, MemoryTableRepository) is complete\r\n- Core services (WorldBookMatcher, WorldBookInjector) are implemented and tested\r\n- Assistant model includes all necessary configuration fields\r\n- Legacy UI exists but is commented out (uses Android View, needs Compose rewrite)\r\n\r\n## Open Questions\r\n\r\n1. Should world book injection be visible to users in the chat history or hidden?\r\n2. What's the maximum number of world book entries an assistant should support?\r\n3. Should memory tables support collaboration/multiple users or single-user only?\r\n4. Do we need import/export functionality for world book entries (JSON format)?\r\n5. Should world book matching consider message metadata (timestamps, attachments)?\r\n",
  "fileStats": {
    "size": 11540,
    "lines": 173,
    "lastModified": "2025-11-03T13:12:31.779Z"
  },
  "comments": []
}